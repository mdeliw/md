### System Clock

#### # Fun

We are occupying a wobbling, spherically shaped rock that follows what appears to be an elliptical orbit around Sun's native residence. Suffering from a collective amnesia, we've become bound by what we call time and are confined to a minutest fraction of what we call space

The legion of definitions of time that we’ve come up with only aids us in perpetuating this self-imposed ignorance of the time-transcendent laws that govern Sun's native habitat. We continually talk, write, and speculate about time. We keep track of it and attempt to “maximize” it. Our scientists have developed constructs called calendars and a stunning granularity of units to measure time’s “passage.” We identify some of it as past and some as future that’s somehow divided by the elusive present.

As though it were a container of sorts, “our time” is filled with a host of routine and unexpected activities. We ascribe numerous attributes to those activities but have not yet grasped them as being nothing more than simple processes in energy conversion. We routinely try to find more time and use it as a resource to fuel the achievement of surprisingly meager goals. We repeatedly lament about being short of time as though capricious gods whimsically throttled its flow to us.



 the center of the sun where seasons, day, and night seem as most humorous concepts, we actually seem to enjoy time’s numerous effects and ploys. Our obsession with aging, for one, being the biggest of them all!

#### # Scientific perspective

The science of physics that concerns itself with the study of matter/energy interactions is governed by numerous laws and theories, most of which pertain to objects that are in motion. The concept of motion, in turn, is irrevocably linked to that of time. Objects, motion, time. To most of us these concepts appear as very concrete, constant, and obvious. But our scientists have been learning otherwise.

The learnings include the laws of motion of classical mechanics, electromagnetism, the special and general theory of relativity, quantum mechanics, Isaac Newton’s universal theory of gravitation, the string theory, and more. They all deal with the concepts of motion and time, from the micro to the macro levels.

The inherent reliance of the scientific method on the process of experimentation to prove a hypothesis is ultimately a trap. It confines all of our experiments that are aimed at a better understanding of time, space, and the structure of matter to a limited number of dimensions and energy states—those in which our experimental instruments can function. A pity indeed! We’ve become conditioned to trust inanimate objects more than themselves. We truly do not know who we really are!

In all cases, the instruments we use in conducting our experiments seem to interfere with the results of those experiments, no matter how minute and, in most instances, irrelevant the interference might be in the context of “everyday life.” But that interference makes itself known and becomes much more pronounced at the subatomic level, which is where we seem to be continually baffled by new discoveries and phenomena. We've even come up with a principle to reflect the limitation in our ability to determine with absolute precision the state of the particles that constitute our very forms: the “uncertainty principle.”

The knowledge we continue to gain via the scientific method creates a box, one that perhaps grows bigger as a function of our time but never transcends its fundamental nature. 

**Classical mechanics** fits wells with our senses where motion of objects is very slow compared to speed of light and objects are much bigger that subatomic particles.  In as much as scientists seem to have adopted the speed of light as a universal constant of 186,282 miles/sec, the absolutely exact speed of light is still unknown and subject to experimental error. Classical mechanics breaks down at speeds approaching speed of light. 

**Newton's laws of motion** has served us well with the inherent assumtion that all time-related measurements happen in a coordinate system or a frame of reference that is at rest. This offers us a sense of comfort of immutability and absoluteness. Just ask anyone: how fast were you traveling between A to B, where A and B represent locations on earth? Not too many will factor in the approximately 18.5 miles/sec orbital speed of earth around the sun when giving an answer. Otherwise, the answer might be, “During the last hour, I traveled at approximately 45 miles/hr between A and B, but I also traveled approximately 66,585 miles around the sun.”  

Time is intertwined in every aspect of our lives yet how many would be able to define a second in terms other than as a portion of a still larger unit (a minute, an hour, or a day) or movement of one of the arms on a clock, the instrument that tracks time. 

A second, or the base unit of time in the International System of Units is “equal to the duration of 9,192,631,770 periods of the radiation corresponding to the transition between the two hyperfine levels of the ground state of the cesium-133 atom.” Period is the interval of time required for a phenomenon to complete a cycle and begin to repeat itself.

> We define time with time.  It’s almost impossible to define time when we are confined by it and can’t look outside of it. An abstract concept of time is a form of energy itself that facilitates transformations between other energy forms

In the contest between Newton and Albert Einstein, it seemed for a while that Newton’s theory of gravity could have been the answer to transcending the speed of light. Newton’s theory of gravity implied that the transmission of gravitational influences between objects was instantaneous regardless of the distance between them. But the formidable Einstein seems to have prevailed in that contest. His **general theory of relativity**, which deals with gravity and accelerated motion, still affirms the invariance of the speed of light. 

The special theory of relativity overturned the concept of the invariance of time and replaced it with the assumption about the invariance of the speed of light. The theory concludes that:

- The experience of time appears to vary as a function of one's motion relative to a frame of reference. 
- The concept of motion becomes meaningless, unless it is defined with respect to, or as being relative to, another object.

The principle of relative motion doesn't apply to light which appears to travel at a constant speed regardless of an observer's frame of reference. Time appears to move the slowest for those who are observed moving at the highest speed, and, vice versa, fastest for those at rest. This is called the time dilation factor. This assumption doesn't factor effects of gravity and accelerated motion - and hence called the special theory of relativity.

> Something that experiences passage of time isn't moving at the speed of light. Hence moving at the speed of light is considered as being in a ultimate state of synchronization.

Einstein struggled with the fact that gravitational forces move faster than speed of light. His insight produced the concept of warp in time and space.  The space warps explain how gravitational influences between objects are transmitted, but they also cap the speed of those transmissions to the speed of light. The time warps, in turn, explain how clocks slow down in the presence of strong gravitational fields. 

The laws of classical mechanics that govern how an object behaves seem to be clearly differentiated from the object’s properties that define what an object is. But that’s not the case at the **quantum level**. At the quantum level, the properties of an “object” (typically, a subatomic particle) can become indistinguishable from the “object’s” behavior. In comparison with the special theory of relativity, whose effects become pronounced at very high speeds (by human standards, that is!), quantum mechanics operate at the subatomic levels where the distances are extremely small and durations of events tend to be extremely short (again, by human standards!). But human perceptions, even if propped up by the most accurate of instruments, are relative at best. For those particles whose “visits” into the quantum world result from collisions and interactions with other particles, the fact that they spend a billionth or less of a human second in the quantum world does not diminish an “entire lifetime” experience for them. 

#### # Time - Historical

Epochs, eras, calendars, and a variety of time units are nothing more but an attempt to identify and place labels on the collective planetary energy states. The crutch of time allows us to view the changes in these states as a sort of growth or evolution, a comfortable progression in time.

As a means of imposing our own sense of organization upon the interplay of our earthly roles and planetary energy states, we have come up with the concept of calendars. The calendar construct affords the longer units of time (days, weeks, months, years) some semblance of order.

#### # Hybrid Logical Clock

##### Time in distributed system / Ordering

Ordering is just a way of telling that something is smaller than something else. Numbers have **total order**, and in the case of **partial order** that is not the case. In distributed system we have to deal with partial ordering. 

For both total / partial ordering and distributed system, the following is true:

- Transitivity - If `a` happened before `b`, anhis d `b` happened before `c`, then `a` happened before `c`.
- Asymmtericity - If `a` happened before `b` and `b` happened before `a`, then `a` equals (or is) `b`.

However, a total order also includes totality:

- Totality - `a ≤ b or b ≤ a (totality) for all a, b in X`

And, a partial order also includes reflexivity:

- Reflexive - `a ≤ a (reflexivity) for all a in X`

In partial ordering, there is no concept of comparision, and hence adding the notion of time pattern allows us to have order. 

##### Clocks

- We have access to perfect, global clock - allows total ordering across all systems. Google Spanner, Google TrueTime, TiDB, PostGres GTM.  This is an ideal scenario. This is limited by the lack of accuracy of clocks in commodity computers, by latency if a clock synchronization protocol such as [NTP](http://en.wikipedia.org/wiki/Network_Time_Protocol) is used and fundamentally by the nature of spacetime.
- We have access to imperfect local clock i.e. in a local node - allows total ordering on a local node, but events across the systems can't be ordered - this is closer to real-world situation.
- We don't have access to clock - rejects the concept of a physical clock, and uses logical ordering of events. Its used to track casuality - which means that an effect can only happen because of a cause which happened in the past. Remember, a timestamp is simply a shorthand for the state of the world up to that point - so we can use counters and communication to determine whether something happened before, after or concurrently with something else.

##### Logical Clocks

The **Lamport clock** is just a counter that is increased when a process performs something, and a process receives a message with the counter from another process.

<img src="/Users/mdeliw/Documents/Info/image-20191112095338700.png" alt="image-20191112095338700" style="zoom:30%;" />

> Lamport - (`e happens before f => lc.e < lc.f`), however the reverse is not true if `e` and `f` are not linked. 

The **vector clock** is an extension of Lamport clock, and uses a counter per node. They are more advanced, but require storing `N` clocks for `N` nodes.

<img src="/Users/mdeliw/Documents/Info/image-20191112095530029.png" alt="image-20191112095530029" style="zoom:40%;" />

> Vector - If a happens before b, then timestamp(a) < timestamp(b), and the reverse is also true. 
> (`e happens before f <=> vc.e < vc.f`)

The **Hybrid clock** combines physical and logical clock as a better way to order events. With physical clocks, its impossible to have all nodes to be in perfect synch. Centralized clock implementations such as Google's Spanner / TrueTime has a uncertainity interval of < 7ms, and NPT has uncertainity interval < 250ms.  The best approach is to wait out the uncertainity period. 

> Hybrid logical clock preserves the property of logical clocks (`e happened before f => hlc.e < hlc.f`) and as such can identify and return consistent global snapshots without needing to wait out clock synchronization uncertainties.

HLC was designed to provide one-way (as with LC rather than VC) causality detection while maintaining the clock value close to the physical clock, so one can use HLC timestamp instead of a physical clock. 

HLC allows us to capture `happens-before` relation while assigning timestamps that are very close to the physical clocks. The HLC timestamp of an event e, is a tuple ⟨`l.e,c.e`⟩. `l.e` is our best approximation of the physical time when `e` occurs. `c.e` is a bounded counter that is used to capture causality whenever `l.e` is not enough to capture causality. Specifically, if we have two events `e1` and `e2` such that `e1` happens-before `e2` and `l.e1 = l.e2` , to capture causality between `e1` and `e2` , we set `c.e1` to a value higher than `c.e2` .

**Why using HLCs?** We want to timestamp versions such that two following requirements are satisfied: 

- timestamps are close (within clock drift error) to the physical time when the event of writing occurs, and
- timestamps capture `happens-before` relation

Logical clocks fail to satisfy the first requirements. Specifically, logical timestamps have no relation to the wall clock time. This causes several problems. First, we cannot use timestamps to provide clients with the version of a data object at a given physical time. More importantly, we cannot resolve conflicting writes based on timestamp.

Physical clocks fail to satisfy the second requirement as a perfect clock synchronization is impossible. 

HLCs solves both issues: it allows us to capture the happens-before relation, and at the same time, allows us to provide conflict resolution with respect to the physical time. Basically, using pretty clever algorithm and clock representation, HLC achieves

- one-way causality detection,
- fixed space requirement,
- bounded difference from physical time





| Concept                 | Convention | Description                                                  |
| ----------------------- | ---------- | ------------------------------------------------------------ |
| HLC                     | `lt.j`     | The maximum `pt` seen so far by all nodes when communicating with node `j`. |
| Logical bounded counter | `c.j`      | Increase in counter per casual event. Essentially, this captures casuality. When physical time advances, logical bounded counter is set to zero. When physical time doesn't advance, the logical bounded counter is incremented by 1. |
| Physical time           | `pt.j`     | Machine wall time                                            |

**pseudo code**:

```javascript
// initial on node j
lt.j = 0;
c.j = 0;

// node j has a local event or sends event to another node
temp = lt.j;
lt.j = max(temp, pt.j)
if (l.j == temp) then 
	c.j++; 
else 
  c.j=0;

hlc = lt.j | c.j;

// node j receives event from another node
// lt.m is max pt seen so far across all nodes communicating with node j.
// c.m is max bounded counter seen so far across all nodes communicating with node j.
temp = lt.j;
lt.j = max(temp, lt.m, pt.j)
if (lt.j == temp and lt.j == l.m)
  c.j = max(c.m, c.j) + 1
else if (lt.j == temp)
  c.j = c.j++
else if (lt.j == l.m)
  c.j = c.m + 1

hlc = lt.j | c.j
```



<img src="/Users/mdeliw/Documents/Info/image-20191112100549440.png" alt="image-20191112100549440" style="zoom:50%;" />

HLC format is based on NTP compatible 64-bit integer:

-  5-bits are optionally reserved
- 43-bits or 48-bits (if 5-bits are not reserved ) for `lt`
- 16-bits for casuality `c`

If clocks are accurate to milliseconds, 43-bits gives you 274 years (2^43/1000/60/60/24/365), and 16-bits gives you 65,536.  This means that a single node could in theory execute 65,536 instructions per millisecond or 65 million instructions per second. 